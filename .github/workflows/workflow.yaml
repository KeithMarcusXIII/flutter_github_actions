name: github_actions
on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        type: environment
        required: true
      flutter_channel:
        description: "Flutter channel"
        type: choice
        default: stable
        required: false
        options:
          - master
          - beta
          - stable
      flutter_version:
        description: "Flutter version"
        type: string
        default: "3.3.2"
        required: false
  workflow_call:
    secrets:
      DART_DEFINED_VAR1:
        required: true
    inputs:
      environment:
        required: true
        type: string
      concurrency:
        required: false
        type: number
        default: 4
      coverage_excludes:
        required: false
        type: string
        default: ""
      flutter_channel:
        required: false
        type: string
        default: "stable"
      flutter_version:
        required: false
        type: string
        default: "3.3.2"
      working_directory:
        required: false
        type: string
        default: "."
      min_coverage:
        required: false
        type: number
        default: 100
      test_optimization:
        required: false
        type: boolean
        default: true
      test_recursion:
        required: false
        type: boolean
        default: false
      runs_on:
        required: false
        type: string
        default: "self-hosted"
      build_env:
        required: true
        type: string

jobs:
  setup:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup flutter
        uses: ./.github/actions/setup-flutter
      - name: Check flutter sdk
        run: |
          echo "$FLUTTER_ROOT"
          which flutter
          flutter doctor

  analyze:
    runs-on: self-hosted
    needs: setup
    steps:
      - name: Setup flutter
        uses: ./.github/actions/setup-flutter
      - name: Check formatting
        run: flutter format --set-exit-if-changed lib test
      - name: Analyze
        run: flutter analyze lib test

  # test:
  #   runs-on: self-hosted
  #   needs: setup
  #   steps:
  #     - name: Run Tests
  #       run: very_good test -j ${{inputs.concurrency}} ${{(inputs.test_recursion && '--recursive') || ''}} ${{(inputs.test_optimization && '--optimization') || '--no-optimization'}} --coverage --test-randomize-ordering-seed random

  build:
    runs-on: self-hosted
    environment: inputs.environment
    needs:
      - setup
      - analyze
      # - test
    steps:
      - name: Setup flutter
        uses: ./.github/actions/setup-flutter
      - name: Build appbundle
        run: flutter build appbundle --flavor staging --obfuscate --split-debug-info=debug_info --dart-define=DART_DEFINED_VAR1={{secrets.DART_DEFINED_VAR1}}
# with:
#   coverage_excludes: "*.g.dart *.freezed.dart"
#   flutter_channel: beta
#   flutter_version: 3.1.0
#   runs_on: self-hosted
#
